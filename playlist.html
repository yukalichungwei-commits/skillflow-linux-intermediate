<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">章節清單</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2c3e50;
            --background-color: #f4f7f6;
            --card-bg-color: #ffffff;
            --text-color: #333333;
            --light-text-color: #777777;
        }
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            line-height: 1.6;
        }
        header {
            background-color: var(--secondary-color);
            color: #ffffff;
            text-align: center;
            padding: 2rem 1rem;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            position: relative;
        }
        header h1 {
            margin: 0;
            font-size: 2.5rem;
        }
        header p {
            margin: 0.5rem 0 0;
            font-size: 1.1rem;
            color: #bdc3c7;
        }
        .back-button {
            position: absolute;
            top: 1rem;
            left: 1rem;
            background-color: transparent;
            border: 2px solid #ffffff;
            color: #ffffff;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            text-decoration: none;
            font-weight: bold;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .back-button:hover {
            background-color: #ffffff;
            color: var(--secondary-color);
        }
        .filter-container {
            max-width: 900px;
            margin: 1rem auto;
            padding: 0 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }
        .filter-container label {
            font-weight: bold;
        }
        #difficulty-filter,
        #skill-filter {
            padding: 0.5rem;
            border-radius: 5px;
            border: 1px solid var(--light-text-color);
        }
        #chapter-list-container {
            max-width: 900px;
            margin: 2rem auto;
            padding: 0 1rem;
        }
        .chapter-card {
            background-color: var(--card-bg-color);
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            padding: 1.5rem;
            margin-bottom: 2rem;
            border-left: 4px solid var(--primary-color);
        }
        .chapter-card h2 {
            margin-top: 0;
            font-size: 1.5rem;
            color: var(--secondary-color);
        }
        .chapter-details {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            font-size: 0.9rem;
            color: var(--light-text-color);
            margin-bottom: 1rem;
        }
        .chapter-details span {
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }
        /* 新增的按鈕樣式 */
        .video-button {
            display: inline-block;
            background-color: var(--primary-color);
            color: white;
            padding: 10px 20px;
            text-align: center;
            text-decoration: none;
            border-radius: 5px;
            transition: background-color 0.3s ease;
            margin-top: 1rem;
        }
        .video-button:hover {
            background-color: #2980b9;
        }
    </style>
</head>
<body>
    <header>
        <a href="index.html" class="back-button">返回首頁</a>
        <h1 id="playlist-title"></h1>
        <p id="playlist-description">章節內容</p>
    </header>
    <div class="filter-container">
        <label for="difficulty-filter">篩選難度:</label>
        <select id="difficulty-filter">
            <option value="All">全部</option>
        </select>
        <label for="skill-filter">篩選技能:</label>
        <select id="skill-filter">
            <option value="All">全部</option>
        </select>
    </div>
    <main id="chapter-list-container">
        </main>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            const playlistName = decodeURIComponent(params.get('playlist'));
            const container = document.getElementById('chapter-list-container');
            const playlistTitleElem = document.getElementById('playlist-title');
            const difficultyFilter = document.getElementById('difficulty-filter');
            const skillFilter = document.getElementById('skill-filter');
            let allChapters = [];

            if (!playlistName) {
                container.innerHTML = '<p>找不到指定的播放清單。</p>';
                return;
            }

            playlistTitleElem.textContent = playlistName;

            fetch('structured_output.json')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    const playlist = data.學習路徑.find(p => p.播放清單 === playlistName);
                    if (playlist && playlist.章節詳情) {
                        allChapters = playlist.章節詳情;

                        // Populate difficulty filter dynamically
                        const allDifficulties = new Set();
                        allChapters.forEach(chapter => {
                            if (chapter.難度分級) {
                                allDifficulties.add(chapter.難度分級);
                            }
                        });
                        const sortedDifficulties = Array.from(allDifficulties).sort();
                        sortedDifficulties.forEach(difficulty => {
                            const option = document.createElement('option');
                            option.value = difficulty;
                            option.textContent = difficulty;
                            difficultyFilter.appendChild(option);
                        });

                        // Populate skill filter dynamically
                        const allSkills = new Set();
                        allChapters.forEach(chapter => {
                            if (chapter.技能) {
                                const skillsArray = chapter.技能.split(',').map(s => s.trim());
                                skillsArray.forEach(skill => {
                                    allSkills.add(skill);
                                });
                            }
                        });
                        const sortedSkills = Array.from(allSkills).sort();
                        sortedSkills.forEach(skill => {
                            const option = document.createElement('option');
                            option.value = skill;
                            option.textContent = skill;
                            skillFilter.appendChild(option);
                        });

                        renderChapters(allChapters);
                    } else {
                        container.innerHTML = '<p>找不到該播放清單的章節內容。</p>';
                    }
                })
                .catch(error => {
                    console.error('Error fetching data:', error);
                    container.innerHTML = '<p>載入資料時發生錯誤。請確認 Python_Beginner_structured_output.json 檔案是否存在。</p>';
                });

            // Listen for changes in the filters
            difficultyFilter.addEventListener('change', filterAndRender);
            skillFilter.addEventListener('change', filterAndRender);

            function filterAndRender() {
                const selectedDifficulty = difficultyFilter.value;
                const selectedSkill = skillFilter.value;

                const filteredChapters = allChapters.filter(chapter => {
                    let difficultyMatch = false;
                    if (selectedDifficulty === 'All') {
                        difficultyMatch = true;
                    } else {
                        if (chapter.難度分級 && chapter.難度分級 === selectedDifficulty) {
                            difficultyMatch = true;
                        }
                    }

                    let skillMatch = false;
                    if (selectedSkill === 'All') {
                        skillMatch = true;
                    } else {
                        if (chapter.技能 && chapter.技能.includes(selectedSkill)) {
                            skillMatch = true;
                        }
                    }

                    return difficultyMatch && skillMatch;
                });

                renderChapters(filteredChapters);
            }

            function renderChapters(chapters) {
                container.innerHTML = '';
                if (chapters.length === 0) {
                    container.innerHTML = '<p>找不到符合篩選條件的課程。</p>';
                    return;
                }

                chapters.forEach(chapter => {
                    const chapterCard = document.createElement('div');
                    chapterCard.classList.add('chapter-card');

                    const chapterTitle = document.createElement('h2');
                    chapterTitle.textContent = chapter.章節名稱;
                    chapterCard.appendChild(chapterTitle);

                    const chapterDetails = document.createElement('div');
                    chapterDetails.classList.add('chapter-details');

                    if (chapter.觀看人數) {
                        const viewsSpan = document.createElement('span');
                        viewsSpan.textContent = `觀看人數: ${chapter.觀看人數}`;
                        chapterDetails.appendChild(viewsSpan);
                    }

                    if (chapter.影片時長) {
                        const durationSpan = document.createElement('span');
                        durationSpan.textContent = `影片時長: ${chapter.影片時長}`;
                        chapterDetails.appendChild(durationSpan);
                    }

                    if (chapter.技能) {
                        const skillsSpan = document.createElement('span');
                        skillsSpan.textContent = `技能: ${chapter.技能}`;
                        chapterDetails.appendChild(skillsSpan);
                    }

                    if (chapter.難度分級) {
                        const difficultySpan = document.createElement('span');
                        difficultySpan.textContent = `難度: ${chapter.難度分級}`;
                        chapterDetails.appendChild(difficultySpan);
                    }

                    chapterCard.appendChild(chapterDetails);

                    // 修正：將嵌入影片改為按鈕連結
                    if (chapter.影片連結) {
                        const videoLink = document.createElement('a');
                        videoLink.classList.add('video-button');
                        videoLink.textContent = '觀看影片';
                        videoLink.href = chapter.影片連結;
                        videoLink.target = '_blank'; // 在新視窗開啟
                        chapterCard.appendChild(videoLink);
                    }

                    container.appendChild(chapterCard);
                });
            }
        });
    </script>
</body>
</html>